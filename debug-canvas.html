<!DOCTYPE html>
<html>
<head>
    <title>Canvas Debug Test</title>
    <style>
        body { margin: 20px; background: #222; color: #fff; font-family: monospace; }
        canvas { border: 2px solid #0f0; margin: 10px; }
        .debug-info { margin: 10px 0; }
        button { padding: 10px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Canvas Debug Test</h1>
    <canvas id="testCanvas" width="800" height="600"></canvas>
    <br>
    <button onclick="capturePixelData()">Capture Pixel Data</button>
    <button onclick="drawTestRectangle()">Draw Test Rectangle</button>
    <button onclick="clearCanvas()">Clear Canvas</button>

    <div class="debug-info">
        <h3>Debug Info:</h3>
        <div id="debugOutput"></div>
    </div>

    <script type="module">
        // Import our game modules to test them directly
        import { GraphicsEngine } from './src/engine/graphics/graphics-engine.ts';

        const canvas = document.getElementById('testCanvas');
        let graphics = null;

        // Initialize graphics engine
        try {
            graphics = new GraphicsEngine(canvas);
            console.log('Graphics engine initialized');

            // Load white texture
            graphics.getTextureManager().createWhiteTexture();

            document.getElementById('debugOutput').innerHTML += 'Graphics engine initialized successfully<br>';
        } catch (error) {
            console.error('Failed to initialize graphics:', error);
            document.getElementById('debugOutput').innerHTML += `Error: ${error.message}<br>`;
        }

        // Test drawing a simple sprite
        window.drawTestRectangle = function() {
            if (!graphics) {
                alert('Graphics engine not initialized');
                return;
            }

            try {
                graphics.beginFrame();

                // Draw a large green rectangle in the center
                graphics.drawSprite({
                    position: { x: 400, y: 300 },
                    size: { x: 200, y: 100 },
                    texture: graphics.getTextureManager().getTexture('__white'),
                    color: { r: 0, g: 1, b: 0, a: 1 },
                    anchor: { x: 0.5, y: 0.5 }
                });

                graphics.endFrame();

                console.log('Test rectangle drawn at (400, 300) with size (200, 100)');
                document.getElementById('debugOutput').innerHTML += 'Test rectangle drawn<br>';
            } catch (error) {
                console.error('Error drawing test rectangle:', error);
                document.getElementById('debugOutput').innerHTML += `Draw error: ${error.message}<br>`;
            }
        };

        window.clearCanvas = function() {
            if (graphics) {
                graphics.beginFrame();
                graphics.endFrame();
                console.log('Canvas cleared');
            }
        };

        window.capturePixelData = function() {
            const gl = canvas.getContext('webgl2');
            const width = canvas.width;
            const height = canvas.height;

            // Read pixel data from the canvas
            const pixels = new Uint8Array(width * height * 4);
            gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);

            // Analyze the pixel data
            let nonBlackPixels = 0;
            let uniqueColors = new Set();

            for (let i = 0; i < pixels.length; i += 4) {
                const r = pixels[i];
                const g = pixels[i + 1];
                const b = pixels[i + 2];
                const a = pixels[i + 3];

                // Check if pixel is not black
                if (r > 0 || g > 0 || b > 0) {
                    nonBlackPixels++;
                    uniqueColors.add(`rgb(${r},${g},${b})`);
                }
            }

            const debugInfo = `
                <strong>Pixel Analysis:</strong><br>
                Total pixels: ${width * height}<br>
                Non-black pixels: ${nonBlackPixels}<br>
                Unique colors: ${uniqueColors.size}<br>
                Colors found: ${Array.from(uniqueColors).join(', ')}<br>
            `;

            document.getElementById('debugOutput').innerHTML += debugInfo;
            console.log('Pixel analysis:', { nonBlackPixels, uniqueColors: Array.from(uniqueColors) });
        };

        // Auto-capture pixel data every 2 seconds when graphics is ready
        setInterval(() => {
            if (graphics && window.capturePixelData) {
                window.capturePixelData();
            }
        }, 2000);

    </script>
</body>
</html>